<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>왕희 페스티벌 우선입장권 예매 및 확인</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better Korean display */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Ensure responsive form width */
        .container {
            max-width: 600px;
            width: 100%;
        }
        /* Seat grid styling */
        .seat-grid {
            display: grid;
            /* Changed: Use auto-fit with minmax for responsive columns */
            /* This will create as many columns as possible, each at least 28px wide,
               and taking up equal fractional space if more is available. */
            grid-template-columns: repeat(auto-fit, minmax(28px, 1fr));
            column-gap: 1px; /* Reduced horizontal gap between seats */
            row-gap: 2px;    /* Maintain vertical gap */
            width: 100%;
            border: 1px solid #e2e8f0; /* Light grey border for the grid area */
            padding: 8px;
            border-radius: 8px;
            background-color: #f8fafc;
        }
        .seat {
            /* Changed: Removed fixed width. Now it will take the width of its grid column. */
            /* width: 28px; */
            height: 28px; /* Fixed height for each seat */
            background-color: #cbd5e1; /* Grey for unselected */
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem; /* Smaller font for seat numbers */
            color: #475569;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            position: relative; /* For absolute positioning of number */
            overflow: hidden; /* Hide overflowing numbers if too big */
        }
        .seat.selected {
            background-color: #10b981; /* Green for selected */
            color: white;
        }
        .seat.reserved {
            background-color: #ef4444; /* Red for reserved seats */
            color: white;
            cursor: not-allowed; /* Indicate that it's not selectable */
            pointer-events: none; /* Disable click events */
        }
        .seat:hover:not(.reserved) { /* Hover effect only for non-reserved seats */
            opacity: 0.8;
        }

        /* Modal specific styles (for reservation confirmation and warning) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
        /* Style for the verification code */
        .verification-code {
            font-size: 1.8rem; /* Larger font size */
            font-weight: bold; /* Bold text */
            color: #4f46e5; /* A distinct color, e.g., indigo */
            background-color: #e0e7ff; /* Light background for emphasis */
            padding: 8px 12px;
            border-radius: 6px;
            cursor: copy; /* Indicate it's copyable */
            display: inline-block; /* To apply padding and background */
            margin-top: 10px;
            letter-spacing: 2px; /* Add some letter spacing */
        }
        .verification-code:active {
            transform: scale(0.98); /* Slight press effect on click */
        }
        /* Message box styling (for general messages, not popups) */
        .message-box {
            margin-top: 1rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            text-align: center;
            border-radius: 0.375rem;
        }
        .message-box.hidden {
            display: none;
        }

        /* New style for centered admin confirmation modal content */
        .admin-confirm-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 350px; /* Smaller width */
            position: absolute; /* Position absolutely within the overlay */
            left: 50%; /* Center horizontally */
            top: 50%; /* Center vertically */
            transform: translate(-50%, -50%); /* Adjust for both horizontal and vertical centering */
            transition: transform 0.3s ease-in-out; /* Keep animation */
            z-index: 1001; /* Ensure it's above other modals if they overlap */
        }
        /* For the show animation, we apply transform directly to this content */
        #adminConfirmModal.show .admin-confirm-modal-content {
            transform: translate(-50%, -50%); /* No change in Y for animation, just for initial centering */
        }
    </style>
</head>
<body>
    <div class="container bg-white p-8 rounded-lg shadow-xl border border-gray-200">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">왕희 페스티벌</h1>
                <h2 class="text-2xl font-semibold text-gray-800">우선입장권 예매 사이트</h2>
            </div>
            <nav class="flex space-x-4">
                <a href="#" id="nav-reserve" class="text-indigo-600 hover:text-indigo-800 font-medium whitespace-nowrap">예매하기</a>
                <a href="#" id="nav-check" class="text-gray-600 hover:text-gray-800 font-medium whitespace-nowrap">예매확인</a>
                <a href="https://www.instagram.com/daeshin_high_1938?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" class="text-gray-600 hover:text-gray-800 font-medium whitespace-nowrap">문의사항</a>
            </nav>
        </header>

        <section class="mb-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200">
            <h3 class="text-xl font-bold text-indigo-600 mb-4">우선입장권 안내</h3>
            <div class="text-gray-700">
                <p>본 우선입장권은 왕희 페스티벌에 일반 관객보다 먼저 입장할 수 있는 티켓입니다.</p>
                <p>좌석은 지정되어 있지 않으며, 실제 입장은 입장권 번호와 무관하게 선착순으로 진행됩니다.</p>
            </div>
        </section>

        <section id="reservationSection" class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">예매하기</h3>
            <form id="reservationForm" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">예매자 이름</label>
                    <input type="text" id="name" name="name" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">입장권 선택</label>
                    <div id="seatGrid" class="seat-grid">
                        </div>
                    <p id="selectedSeatsDisplay" class="text-sm text-gray-600 mt-2">선택한 입장권: 없음</p>
                    <p class="text-xs text-gray-500 mt-1">최대 4개 입장권까지 선택 가능합니다.</p>
                </div>

                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    예매하기
                </button>
            </form>
            <div id="messageBoxReserve" class="message-box hidden"></div>
        </section>

        <section id="checkSection" class="p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">예매확인</h3>
            <form id="checkReservationForm" class="space-y-4">
                <div>
                    <label for="verificationCodeInput" class="block text-sm font-medium text-gray-700 mb-1">본인 확인 코드를 입력해 주세요</label>
                    <input type="text" id="verificationCodeInput" name="verificationCode" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm uppercase"
                           placeholder="예: AB13D">
                </div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    예매 정보 확인
                </button>
            </form>

            <div id="reservationDetails" class="mt-6 p-4 bg-white rounded-lg border border-gray-200 hidden">
                <h4 class="text-xl font-semibold text-indigo-700 mb-3">예매 정보</h4>
                <p class="text-base text-gray-700 mb-2">이름: <span id="detailUserName" class="font-medium"></span></p>
                <p class="text-base text-gray-700 mb-2">선택한 입장권: <span id="detailSelectedTickets" class="font-medium"></span></p>
                <p class="text-base text-gray-700">본인 확인 코드: <span id="detailVerificationCode" class="font-medium"></span></p>
                <button id="userCancelReservationButton"
                        class="mt-4 py-1 px-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out whitespace-nowrap hidden">
                    예매 취소
                </button>
            </div>

            <div id="messageBoxCheck" class="message-box hidden"></div>
        </section>

        <section id="adminSection" class="p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">관리자 모드</h3>
            <p class="text-sm text-red-600 mb-4">
               ⚠️ 경고: 이 관리자 모드는 브라우저의 로컬 저장소에 기반하므로 보안에 취약합니다.<br>
                실제 서비스에서는 서버와 데이터베이스를 사용해야 합니다.
            </p>
            <div id="messageBoxAdmin" class="message-box hidden"></div> <div id="adminReservationList" class="space-y-4 mt-4">
                </div>
            <button id="backToNormalButton"
                    class="mt-6 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                뒤로가기
            </button>
        </section>
    </div>

    <div id="reservationModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeModal">&times;</button>
            <h4 class="text-2xl font-bold text-gray-800 mb-4 text-center">예매가 완료되었습니다!</h4>
            <p class="text-lg text-gray-700 mb-2">이름: <span id="modalUserName" class="font-semibold"></span></p>
            <p class="text-lg text-gray-700 mb-4">선택한 입장권: <span id="modalSelectedTickets" class="font-semibold"></span></p>
            <p class="text-lg text-gray-700 mb-4">본인 확인 코드: <span id="modalVerificationCode" class="verification-code"></span></p>
            <p class="text-sm text-gray-500 text-center">본인 확인 코드를 꼭 복사해 주세요!</p>
            <button id="confirmReservationModal" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                확인
            </button>
        </div>
    </div>

    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeWarningModal">&times;</button>
            <h4 class="text-2xl font-bold text-red-600 mb-4 text-center">주의!</h4>
            <p class="text-lg text-gray-700 text-center">입장 시 본인 확인 코드가 필요합니다.</p>
            <p class="text-lg text-gray-700 text-center font-bold mt-2">꼭 복사해 주세요!</p>
            <button id="confirmWarning" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                확인
            </button>
        </div>
    </div>

    <div id="adminConfirmModal" class="modal-overlay">
        <div class="admin-confirm-modal-content">
            <button class="modal-close-button" id="closeAdminConfirmModal">&times;</button>
            <h4 class="text-xl font-bold text-gray-800 mb-4">예매 취소 확인</h4>
            <p class="text-base text-gray-700 mb-4">정말로 <span id="adminConfirmCodeDisplay" class="font-semibold text-red-600"></span> 예매를 취소하시겠습니까?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmAdminCancel" class="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">확인</button>
                <button id="cancelAdminCancel" class="py-2 px-4 rounded-md text-gray-600 bg-gray-200 hover:bg-gray-300 transition duration-150 ease-in-out">취소</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="modal-overlay">
        <div class="modal-content !max-w-xs !py-8"> <p class="text-xl font-bold text-gray-800 text-center">예매 처리 중...</p>
            <p class="text-sm text-gray-500 text-center mt-2">잠시만 기다려 주세요.</p>
        </div>
    </div>

    <script>
        // --- Common Elements ---
        const navReserve = document.getElementById('nav-reserve');
        const navCheck = document.getElementById('nav-check');
        const reservationSection = document.getElementById('reservationSection');
        const checkSection = document.getElementById('checkSection');

        // --- Reservation Section Elements ---
        const reservationForm = document.getElementById('reservationForm');
        const messageBoxReserve = document.getElementById('messageBoxReserve');
        const seatGrid = document.getElementById('seatGrid');
        const selectedSeatsDisplay = document.getElementById('selectedSeatsDisplay');

        // --- Reservation Check Section Elements ---
        const checkReservationForm = document.getElementById('checkReservationForm');
        const verificationCodeInput = document.getElementById('verificationCodeInput');
        const reservationDetails = document.getElementById('reservationDetails');
        const detailUserName = document.getElementById('detailUserName');
        const detailSelectedTickets = document.getElementById('detailSelectedTickets');
        const detailVerificationCode = document.getElementById('detailVerificationCode');
        const messageBoxCheck = document.getElementById('messageBoxCheck');
        const userCancelReservationButton = document.getElementById('userCancelReservationButton');

        // --- Modal Elements ---
        const reservationModal = document.getElementById('reservationModal');
        const closeModalButton = document.getElementById('closeModal');
        const modalUserName = document.getElementById('modalUserName');
        const modalSelectedTickets = document.getElementById('modalSelectedTickets');
        const modalVerificationCode = document.getElementById('modalVerificationCode');
        const confirmReservationModalButton = document.getElementById('confirmReservationModal');

        // --- Warning Modal Elements ---
        const warningModal = document.getElementById('warningModal');
        const closeWarningModalButton = document.getElementById('closeWarningModal');
        const confirmWarningButton = document.getElementById('confirmWarning');

        // --- Admin Elements ---
        const adminSection = document.getElementById('adminSection');
        const adminReservationList = document.getElementById('adminReservationList');
        const backToNormalButton = document.getElementById('backToNormalButton');
        const messageBoxAdmin = document.getElementById('messageBoxAdmin');

        // --- Admin Confirmation Modal Elements ---
        const adminConfirmModal = document.getElementById('adminConfirmModal');
        const closeAdminConfirmModalButton = document.getElementById('closeAdminConfirmModal');
        const adminConfirmCodeDisplay = document.getElementById('adminConfirmCodeDisplay');
        const confirmAdminCancelButton = document.getElementById('confirmAdminCancel');
        const cancelAdminCancelButton = document.getElementById('cancelAdminCancel');

        // --- Loading Overlay Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');


        // --- Global State Variables ---
        let selectedSeats = [];
        const MAX_SEATS = 4;
        let reservedSeats = JSON.parse(localStorage.getItem('reservedSeats')) || [];
        let allReservations = JSON.parse(localStorage.getItem('allReservations')) || [];
        let isCodeCopied = false;
        let tempUserName = '';
        let tempSelectedTickets = [];
        let tempVerificationCode = '';
        let currentAdminCancellationCode = '';

        // --- Broadcast Channel ---
        // BroadcastChannel 초기화 및 메시지 수신/발신 로직 재활성화
        const reservationChannel = new BroadcastChannel('reservation_updates');

        reservationChannel.onmessage = function(event) {
            if (event.data && event.data.type === 'seats_reserved') {
                reservedSeats = event.data.reservedSeats;
                // 현재 예매 섹션이 활성화되어 있다면 좌석을 다시 생성하여 최신 상태 반영
                if (!reservationSection.classList.contains('hidden')) {
                    generateSeats();
                }
                // 관리자 섹션이 활성화되어 있다면 예매 목록을 다시 렌더링하여 최신 상태 반영
                if (!adminSection.classList.contains('hidden')) {
                    renderAdminReservations();
                }
                // 사용자가 예매 확인 섹션에 있고, 조회된 예매가 취소된 경우 UI 업데이트
                if (!checkSection.classList.contains('hidden')) {
                    const currentCode = verificationCodeInput.value.trim().toUpperCase();
                    // 현재 조회 중인 예매 정보가 allReservations에 더 이상 없는지 확인
                    const found = allReservations.find(res => res.verificationCode === currentCode);
                    if (!found) { // 현재 조회 중인 예매가 취소된 경우
                        reservationDetails.classList.add('hidden');
                        userCancelReservationButton.classList.add('hidden');
                        showMessage(messageBoxCheck, '조회된 예매 정보가 취소되었습니다.', 'bg-yellow-100 text-yellow-700');
                    }
                }
            }
        };


        // --- Utility Functions ---
        /**
         * 지정된 메시지 박스 영역에 메시지를 표시합니다.
         * @param {HTMLElement} messageBoxElement - 메시지를 표시할 메시지 박스 요소.
         * @param {string} message - 표시할 메시지 텍스트.
         * @param {string} typeClass - 메시지 박스 스타일링을 위한 Tailwind CSS 클래스 (예: 성공 시 'bg-green-100 text-green-700', 오류 시 'bg-red-100 text-red-700').
         */
        function showMessage(messageBoxElement, message, typeClass) {
            messageBoxElement.textContent = message;
            messageBoxElement.className = `message-box ${typeClass}`;
            messageBoxElement.classList.remove('hidden');
            setTimeout(() => {
                messageBoxElement.classList.add('hidden');
            }, 3000);
        }

        /**
         * 로딩 오버레이를 표시합니다.
         */
        function showLoading() {
            loadingOverlay.classList.add('show');
        }

        /**
         * 로딩 오버레이를 숨깁니다.
         */
        function hideLoading() {
            loadingOverlay.classList.remove('show');
        }

        /**
         * 지정된 길이의 임의의 영숫자 문자열을 생성합니다.
         * @param {number} length - 임의 코드의 원하는 길이.
         * @returns {string} 생성된 임의 코드.
         */
        function generateRandomCode(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /**
         * 텍스트를 클립보드에 복사합니다.
         * @param {string} text - 복사할 텍스트.
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessage(messageBoxReserve, '본인 확인 코드가 복사되었습니다!', 'bg-blue-100 text-blue-700');
                isCodeCopied = true;
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage(messageBoxReserve, '복사 실패! 수동으로 복사해주세요.', 'bg-red-100 text-red-700');
                isCodeCopied = false;
            }
            document.body.removeChild(textarea);
        }

        // --- Reservation Section Functions ---
        /**
         * 현재 예약된 좌석을 기반으로 좌석 그리드를 생성합니다.
         */
        function generateSeats() {
            const totalSeats = 100;
            seatGrid.innerHTML = '';

            for (let i = 1; i <= totalSeats; i++) {
                const seat = document.createElement('div');
                seat.classList.add('seat');
                seat.textContent = i;
                seat.setAttribute('data-seat-id', i);

                if (reservedSeats.includes(i)) {
                    seat.classList.add('reserved');
                } else {
                    seat.addEventListener('click', () => toggleSeatSelection(seat, i));
                }
                seatGrid.appendChild(seat);
            }
        }

        /**
         * 좌석의 선택 상태를 토글합니다.
         * @param {HTMLElement} seatElement - 좌석 div 요소.
         * @param {number} seatId - 좌석 ID.
         */
        function toggleSeatSelection(seatElement, seatId) {
            if (seatElement.classList.contains('reserved')) {
                showMessage(messageBoxReserve, '이미 예매된 입장권입니다.', 'bg-red-100 text-red-700');
                return;
            }

            const index = selectedSeats.indexOf(seatId);

            if (index > -1) {
                selectedSeats.splice(index, 1);
                seatElement.classList.remove('selected');
            } else {
                if (selectedSeats.length < MAX_SEATS) {
                    selectedSeats.push(seatId);
                    seatElement.classList.add('selected');
                } else {
                    showMessage(messageBoxReserve, `최대 ${MAX_SEATS}개 입장권까지 선택 가능합니다.`, 'bg-red-100 text-red-700');
                    return;
                }
            }
            updateSelectedSeatsDisplay();
        }

        /**
         * 선택된 좌석 번호를 표시하는 텍스트를 업데이트합니다.
         */
        function updateSelectedSeatsDisplay() {
            if (selectedSeats.length === 0) {
                selectedSeatsDisplay.textContent = '선택한 입장권: 없음';
            } else {
                const sortedSeats = [...selectedSeats].sort((a, b) => a - b);
                selectedSeatsDisplay.textContent = `선택한 입장권: ${sortedSeats.join(', ')}`;
            }
        }

        reservationForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;

            if (!name) {
                showMessage(messageBoxReserve, '예매자 이름을 입력해주세요.', 'bg-red-100 text-red-700');
                return;
            }

            if (selectedSeats.length === 0) {
                showMessage(messageBoxReserve, '입장권을 선택해주세요.', 'bg-red-100 text-red-700');
                return;
            }

            // 다음 모달을 위해 임시 변수에 세부 정보 저장
            tempUserName = name;
            tempSelectedTickets = [...selectedSeats];
            // 경고 모달에 필요하므로 여기서 확인 코드 생성
            tempVerificationCode = generateRandomCode(5); 

            showWarningModal(); // 먼저 경고 모달 표시
        });

        // --- Reservation Check Section Functions ---
        const ADMIN_CODE = 'HAESEONG';

        checkReservationForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const inputCode = verificationCodeInput.value.trim().toUpperCase();

            if (!inputCode) {
                showMessage(messageBoxCheck, '본인 확인 코드를 입력해주세요.', 'bg-red-100 text-red-700');
                reservationDetails.classList.add('hidden');
                userCancelReservationButton.classList.add('hidden');
                return;
            }

            if (inputCode === ADMIN_CODE) {
                showAdminPanel();
                return;
            }

            const foundReservation = allReservations.find(reservation =>
                reservation.verificationCode === inputCode
            );

            if (foundReservation) {
                detailUserName.textContent = foundReservation.name;
                detailSelectedTickets.textContent = foundReservation.tickets.join(', ');
                detailVerificationCode.textContent = foundReservation.verificationCode;
                reservationDetails.classList.remove('hidden');
                userCancelReservationButton.classList.remove('hidden'); // 버튼 표시
                userCancelReservationButton.dataset.code = foundReservation.verificationCode; // 버튼에 코드 설정
                showMessage(messageBoxCheck, '예매 정보를 찾았습니다!', 'bg-green-100 text-green-700');
            } else {
                reservationDetails.classList.add('hidden');
                userCancelReservationButton.classList.add('hidden'); // 버튼 숨기기
                showMessage(messageBoxCheck, '일치하는 예매 정보가 없습니다. 코드를 확인해주세요.', 'bg-red-100 text-red-700');
            }
        });

        // 사용자 취소 버튼에 대한 이벤트 리스너
        userCancelReservationButton.addEventListener('click', () => {
            const codeToCancel = userCancelReservationButton.dataset.code;
            if (codeToCancel) {
                showAdminConfirmModal(codeToCancel); // 관리자 확인 모달 재사용
            }
        });

        // --- Modals Functions ---
        function showReservationModal(userName, tickets, verificationCode) {
            modalUserName.textContent = userName;
            modalSelectedTickets.textContent = tickets.join(', ');
            modalVerificationCode.textContent = verificationCode;
            reservationModal.classList.add('show');
            isCodeCopied = false;
        }

        function showWarningModal() {
            warningModal.classList.add('show');
        }

        // hideWarningModal 함수 정의
        function hideWarningModal() {
            warningModal.classList.remove('show');
        }

        closeModalButton.addEventListener('click', (event) => {
            // 경고 모달 표시 조건 제거
            reservationModal.classList.remove('show');
            showSection(checkSection);
        });

        reservationModal.addEventListener('click', (event) => {
            if (event.target === reservationModal) { // 오버레이 클릭인지, 콘텐츠 클릭인지 확인
                // 경고 모달 표시 조건 제거
                reservationModal.classList.remove('show');
                showSection(checkSection);
            }
        });

        confirmReservationModalButton.addEventListener('click', () => {
            reservationModal.classList.remove('show');
            showSection(checkSection);
        });

        closeWarningModalButton.addEventListener('click', () => {
            hideWarningModal(); // 정의된 함수 사용
            // 사용자가 확인 없이 경고를 닫으면 양식 및 선택된 좌석 초기화
            reservationForm.reset();
            selectedSeats = [];
            updateSelectedSeatsDisplay();
            // 임시 변수 초기화
            tempUserName = '';
            tempSelectedTickets = [];
            tempVerificationCode = '';
        });

        confirmWarningButton.addEventListener('click', () => {
            hideWarningModal(); // 정의된 함수 사용

            showLoading(); // 로딩 화면 표시

            // 비동기 확인 및 예약 시뮬레이션
            setTimeout(() => {
                // 최종 예약 직전에 좌석 가용성 재확인 (실시간 확인)
                // 정확성을 위해 localStorage에서 최신 예약된 좌석 가져오기
                let currentReservedSeats = JSON.parse(localStorage.getItem('reservedSeats')) || [];
                let conflictFound = false;
                for (const seatId of tempSelectedTickets) { // 확인을 위해 tempSelectedTickets 사용
                    if (currentReservedSeats.includes(seatId)) {
                        conflictFound = true;
                        // 선택 사항: 충돌하는 좌석을 다른 색상으로 강조하거나 상태 업데이트
                        const conflictingSeatElement = seatGrid.querySelector(`[data-seat-id="${seatId}"]`);
                        if (conflictingSeatElement && !conflictingSeatElement.classList.contains('reserved')) {
                            // 아직 빨간색이 아니면 빨간색으로 만들어 현재 점유되었음을 표시
                            conflictingSeatElement.classList.add('reserved');
                            conflictingSeatElement.classList.remove('selected');
                        }
                        break; // 충돌이 하나라도 발견되면 더 이상 확인하지 않음
                    }
                }

                hideLoading(); // 로딩 화면 숨기기

                if (conflictFound) {
                    showMessage(messageBoxReserve, '이미 선점된 좌석입니다. 다시 선택해주세요.', 'bg-red-100 text-red-700');
                    // 일부 좌석이 점유되었으므로 현재 선택 초기화
                    selectedSeats = []; // 전역 selectedSeats 초기화
                    updateSelectedSeatsDisplay();
                    reservationForm.reset(); // 양식 초기화
                    // 임시 변수 초기화
                    tempUserName = '';
                    tempSelectedTickets = [];
                    tempVerificationCode = '';
                    showSection(reservationSection); // 초기 예약 화면으로 돌아가기
                    return; // 예약 프로세스 중지
                }

                // 충돌이 없으면 예약 진행
                // 확인 코드는 이미 생성되어 tempVerificationCode에 저장됨

                tempSelectedTickets.forEach(seatId => { // 예약된 좌석 업데이트에 tempSelectedTickets 사용
                    if (!reservedSeats.includes(seatId)) { // 중복 방지
                        reservedSeats.push(seatId);
                    }
                    // 예약된 좌석의 시각적 상태 업데이트
                    const seatElement = seatGrid.querySelector(`[data-seat-id="${seatId}"]`);
                    if (seatElement) {
                        seatElement.classList.remove('selected'); // 녹색 '선택됨' 상태 제거
                        seatElement.classList.add('reserved'); // 빨간색 '예약됨' 상태 추가
                    }
                });

                const newReservation = {
                    name: tempUserName,
                    tickets: [...tempSelectedTickets], // 배열 복사를 위해 스프레드 사용
                    verificationCode: tempVerificationCode
                };
                allReservations.push(newReservation);

                localStorage.setItem('reservedSeats', JSON.stringify(reservedSeats));
                localStorage.setItem('allReservations', JSON.stringify(allReservations));

                // BroadcastChannel을 통해 다른 탭/창에 업데이트 전파
                reservationChannel.postMessage({
                    type: 'seats_reserved',
                    reservedSeats: reservedSeats,
                    allReservations: allReservations // allReservations도 함께 전파하여 다른 탭에서 최신 상태를 유지하도록 함
                });

                showReservationModal(tempUserName, tempSelectedTickets, tempVerificationCode); // 확인 모달 표시 진행

                // 예약 성공 후 양식 및 선택된 좌석 초기화
                reservationForm.reset();
                selectedSeats = [];
                updateSelectedSeatsDisplay();
                // 임시 변수 초기화
                tempUserName = '';
                tempSelectedTickets = [];
                tempVerificationCode = '';

            }, 1000); // 1초 로딩 시간 시뮬레이션
        });

        modalVerificationCode.addEventListener('click', () => {
            copyToClipboard(modalVerificationCode.textContent);
        });

        // --- Admin Functions ---
        function showAdminPanel() {
            reservationSection.classList.add('hidden');
            checkSection.classList.add('hidden');
            adminSection.classList.remove('hidden');
            renderAdminReservations();
        }

        /**
         * 관리자 패널에 모든 예약을 렌더링합니다.
         */
        function renderAdminReservations() {
            adminReservationList.innerHTML = '';
            // 렌더링하기 전에 allReservations가 localStorage에서 최신 상태인지 확인
            allReservations = JSON.parse(localStorage.getItem('allReservations')) || [];
            reservedSeats = JSON.parse(localStorage.getItem('reservedSeats')) || []; // reservedSeats도 최신 상태인지 확인

            if (allReservations.length === 0) {
                adminReservationList.innerHTML = '<p class="text-gray-600 text-center">등록된 예매 정보가 없습니다.</p>';
                return;
            }

            allReservations.forEach(reservation => {
                const reservationCard = document.createElement('div');
                reservationCard.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow-md', 'border', 'border-gray-200', 'flex', 'flex-col', 'md:flex-row', 'md:items-center', 'md:justify-between');
                reservationCard.innerHTML = `
                    <div class="mb-2 md:mb-0">
                        <p class="text-lg font-semibold text-indigo-700">이름: ${reservation.name}</p>
                        <p class="text-base text-gray-700">입장권: ${reservation.tickets.join(', ')}</p>
                        <p class="text-base text-gray-700">코드: <span class="font-mono text-purple-700">${reservation.verificationCode}</span></p>
                    </div>
                    <button data-code="${reservation.verificationCode}"
                            class="cancel-button py-1 px-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out whitespace-nowrap">
                        예매 취소
                    </button>
                `;
                adminReservationList.appendChild(reservationCard);
            });

            document.querySelectorAll('.cancel-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const codeToCancel = event.target.dataset.code;
                    showAdminConfirmModal(codeToCancel); // 사용자 정의 확인 모달 표시
                });
            });
        }

        /**
         * 확인 코드로 예약을 취소합니다.
         * @param {string} verificationCode - 취소할 예약의 확인 코드.
         */
        function cancelReservation(verificationCode) {
            const indexToCancel = allReservations.findIndex(res => res.verificationCode === verificationCode);

            if (indexToCancel > -1) {
                const canceledReservation = allReservations[indexToCancel];

                // reservedSeats에서 좌석 제거
                canceledReservation.tickets.forEach(seatId => {
                    const seatIndex = reservedSeats.indexOf(seatId);
                    if (seatIndex > -1) {
                        reservedSeats.splice(seatIndex, 1);
                    }
                });

                // allReservations에서 예약 제거
                allReservations.splice(indexToCancel, 1);

                // localStorage 업데이트
                localStorage.setItem('reservedSeats', JSON.stringify(reservedSeats));
                localStorage.setItem('allReservations', JSON.stringify(allReservations));

                // 관련 섹션 다시 렌더링
                if (!adminSection.classList.contains('hidden')) {
                    renderAdminReservations(); // 관리자 패널에 업데이트된 목록 표시
                    showMessage(messageBoxAdmin, `코드 "${verificationCode}" 예매가 취소되었습니다.`, 'bg-green-100 text-green-700 text-left text-xs');
                } else if (!checkSection.classList.contains('hidden')) {
                    // 사용자가 확인 섹션에 있는 경우, 세부 정보를 숨기고 메시지 표시
                    reservationDetails.classList.add('hidden');
                    userCancelReservationButton.classList.add('hidden');
                    showMessage(messageBoxCheck, `코드 "${verificationCode}" 예매가 취소되었습니다.`, 'bg-green-100 text-green-700');
                }
                
                // BroadcastChannel을 통해 다른 탭/창에 업데이트 전파
                reservationChannel.postMessage({
                    type: 'seats_reserved',
                    reservedSeats: reservedSeats,
                    allReservations: allReservations // allReservations도 함께 전파하여 다른 탭에서 최신 상태를 유지하도록 함
                });

            } else {
                // 현재 섹션에 따라 사용할 메시지 박스 결정
                const targetMessageBox = !adminSection.classList.contains('hidden') ? messageBoxAdmin : messageBoxCheck;
                showMessage(targetMessageBox, `코드 "${verificationCode}"를 찾을 수 없습니다.`, 'bg-red-100 text-red-700');
            }
        }

        backToNormalButton.addEventListener('click', () => {
            showSection(checkSection);
        });

        // --- Admin Confirmation Modal Functions ---
        /**
         * 관리자/사용자 취소를 위한 사용자 정의 확인 모달을 표시합니다.
         * @param {string} code - 취소 확인을 위한 예약의 확인 코드.
         */
        function showAdminConfirmModal(code) {
            currentAdminCancellationCode = code; // 코드 저장
            adminConfirmCodeDisplay.textContent = code; // 모달에 코드 표시
            adminConfirmModal.classList.add('show');
        }

        /**
         * 사용자 정의 확인 모달을 숨깁니다.
         */
        function hideAdminConfirmModal() {
            adminConfirmModal.classList.remove('show');
            currentAdminCancellationCode = ''; // 저장된 코드 초기화
        }

        closeAdminConfirmModalButton.addEventListener('click', () => {
            hideAdminConfirmModal();
        });

        cancelAdminCancelButton.addEventListener('click', () => {
            hideAdminConfirmModal();
            // 적절한 메시지 박스에 메시지 표시
            const targetMessageBox = !adminSection.classList.contains('hidden') ? messageBoxAdmin : messageBoxCheck;
            showMessage(targetMessageBox, `코드 "${currentAdminCancellationCode}" 예매 취소가 취소되었습니다.`, 'bg-yellow-100 text-yellow-700 text-left text-xs');
        });

        confirmAdminCancelButton.addEventListener('click', () => {
            cancelReservation(currentAdminCancellationCode); // 취소 수행
            hideAdminConfirmModal(); // 작업 후 모달 숨기기
        });

        // --- Navigation Logic ---
        /**
         * 지정된 섹션을 표시하고 다른 섹션을 숨깁니다.
         * @param {HTMLElement} sectionToShow - 표시할 섹션 요소.
         */
        function showSection(sectionToShow) {
            reservationSection.classList.add('hidden');
            checkSection.classList.add('hidden');
            adminSection.classList.add('hidden');
            
            // 섹션 전환 시 모든 메시지 박스 및 로딩 오버레이 숨기기
            messageBoxReserve.classList.add('hidden');
            messageBoxCheck.classList.add('hidden');
            messageBoxAdmin.classList.add('hidden');
            hideLoading(); // 섹션 전환 시 로딩 오버레이가 숨겨져 있는지 확인

            sectionToShow.classList.remove('hidden');

            // 활성 탐색 링크 스타일 업데이트
            navReserve.classList.remove('text-indigo-600', 'hover:text-indigo-800');
            navReserve.classList.add('text-gray-600', 'hover:text-gray-800');
            navCheck.classList.remove('text-indigo-600', 'hover:text-indigo-800');
            navCheck.classList.add('text-gray-600', 'hover:text-gray-800');

            if (sectionToShow === reservationSection) {
                navReserve.classList.add('text-indigo-600', 'hover:text-indigo-800');
                navReserve.classList.remove('text-gray-600', 'hover:text-gray-800');
                generateSeats();
            } else if (sectionToShow === checkSection) {
                navCheck.classList.add('text-indigo-600', 'hover:text-indigo-800');
                navCheck.classList.remove('text-gray-600', 'hover:text-gray-800');
                reservationDetails.classList.add('hidden'); // 확인 섹션으로 전환 시 세부 정보 숨기기
                userCancelReservationButton.classList.add('hidden'); // 확인 섹션으로 전환 시 버튼 숨기기
                verificationCodeInput.value = ''; // 입력 필드 지우기
            }
        }

        navReserve.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(reservationSection);
        });

        navCheck.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(checkSection);
        });

        // --- Data Synchronization Function (Bug Fix for inconsistent seats) ---
        /**
         * reservedSeats를 allReservations의 실제 예약과 동기화합니다.
         * 이 함수는 `reservedSeats`에 `allReservations`의 기존 예약에 속한 좌석만 포함되도록 합니다.
         */
        function synchronizeSeatData() {
            const actualReservedSeats = new Set();
            allReservations.forEach(reservation => {
                reservation.tickets.forEach(ticket => {
                    actualReservedSeats.add(ticket);
                });
            });
            // Set을 다시 배열로 변환하고 정렬
            const newReservedSeats = Array.from(actualReservedSeats).sort((a, b) => a - b);
            
            // 불필요한 localStorage 쓰기 및 UI 다시 렌더링을 피하기 위해 변경 사항이 있는 경우에만 업데이트
            if (JSON.stringify(reservedSeats) !== JSON.stringify(newReservedSeats)) {
                reservedSeats = newReservedSeats;
                localStorage.setItem('reservedSeats', JSON.stringify(reservedSeats));
                // 예약 섹션이 보이는 경우 변경 사항을 반영하기 위해 좌석 다시 생성
                if (!reservationSection.classList.contains('hidden')) {
                    generateSeats();
                }
            }
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // localStorage에서 데이터 로드
            allReservations = JSON.parse(localStorage.getItem('allReservations')) || [];
            reservedSeats = JSON.parse(localStorage.getItem('reservedSeats')) || [];
            
            // 데이터 불일치 수정 (예: 14번 좌석 버그)을 위해 데이터 동기화
            synchronizeSeatData();

            showSection(reservationSection); // 로드 시 기본적으로 예약 섹션 표시
        });
    </script>
</body>
</html>
